<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <title>Reconciliation Guardian ‚Äî PayMe Demo</title>
  <meta name="description" content="Prevent shipping unpaid orders. WhatsApp bot cross-checks PayMe vs platform in real time. Register, open WhatsApp, and get instant mismatch alerts.">

  <!-- Favicon / Open Graph (uses PayMe.jpeg from the repo root) -->
  <link rel="icon" href="./PayMe.jpeg" type="image/jpeg">
  <link rel="shortcut icon" href="./PayMe.jpeg" type="image/jpeg">
  <link rel="apple-touch-icon" href="./PayMe.jpeg">
  <meta name="theme-color" content="#0f172a">

  <meta property="og:type" content="website">
  <meta property="og:title" content="Reconciliation Guardian ‚Äî PayMe Demo">
  <meta property="og:description" content="Real-time WhatsApp alerts when PayMe and your platform disagree. Register, join WhatsApp, and see it in action.">
  <meta property="og:image" content="https://dmitreyvladimirov.github.io/DimitryPayMeTest/PayMe.jpeg">
  <meta property="og:url" content="https://dmitreyvladimirov.github.io/DimitryPayMeTest/paymetest_final.html">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Reconciliation Guardian ‚Äî PayMe Demo">
  <meta name="twitter:description" content="WhatsApp bot that stops unpaid shipments with instant reconciliation alerts.">
  <meta name="twitter:image" content="https://dmitreyvladimirov.github.io/DimitryPayMeTest/PayMe.jpeg">

  <style>
    :root{--bg:#0f172a;--card:#111827;--muted:#94a3b8;--text:#e2e8f0;--brand:#22d3ee;--brand-2:#38bdf8;--ok:#10b981;--err:#ef4444;--radius:16px;--shadow:0 10px 30px rgba(0,0,0,.35)}
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    a{color:var(--brand-2);text-decoration:none} a:hover{text-decoration:underline}
    .container{max-width:1000px;margin:0 auto;padding:24px}
    .banner{background:linear-gradient(90deg,#0ea5e9,#22d3ee);color:#003044;text-align:center;padding:10px 14px;font-weight:700}
    .strip{background:#0b1224;border-bottom:1px solid #1f2a44}
    .strip .container{display:flex;gap:14px;align-items:center;flex-wrap:wrap;justify-content:center;font-size:14px;color:var(--muted)}
    header{padding:56px 0 24px}
    .hero{display:grid;grid-template-columns:1.2fr .8fr;gap:28px}
    @media(max-width:900px){.hero{grid-template-columns:1fr}}
    .tag{display:inline-block;font-size:12px;padding:6px 10px;border:1px solid #26314f;border-radius:999px;color:#93c5fd;background:#0b1224}
    h1{font-size:40px;line-height:1.1;margin:12px 0 10px}
    p.lead{font-size:18px;color:#cbd5e1;margin:0 0 20px}
    .cta{display:flex;gap:12px;align-items:center}
    .btn{background:linear-gradient(180deg,var(--brand),var(--brand-2));color:#032238;border:none;border-radius:999px;padding:14px 20px;font-weight:700;cursor:pointer;box-shadow:var(--shadow)}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .pill{display:inline-block;background:#0b1224;border:1px solid #223051;color:#d1d5db;border-radius:999px;padding:8px 12px}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:var(--radius);padding:22px;box-shadow:var(--shadow)}
    .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:18px}
    @media(max-width:900px){.grid-3{grid-template-columns:1fr}}
    section{padding:28px 0}
    h2{font-size:28px;margin:0 0 12px}
    .kvs{display:grid;grid-template-columns:1fr 1fr;gap:18px}
    @media(max-width:900px){.kvs{grid-template-columns:1fr}}
    .kvs .problem,.kvs .solution{border-left:4px solid #334155;padding-left:14px}
    .kvs .solution{border-color:var(--ok)}
    ul.clean{list-style:none;padding:0;margin:10px 0 0}
    ul.clean li{margin:8px 0;padding-left:24px;position:relative}
    ul.clean li:before{content:"‚Ä¢";position:absolute;left:0;color:#22d3ee}
    .form-wrap{display:grid;grid-template-columns:1.1fr .9fr;gap:18px}
    @media(max-width:900px){.form-wrap{grid-template-columns:1fr}}
    form label{display:block;font-size:13px;color:#cbd5e1;margin:10px 0 6px}
    form input, form select{width:100%;padding:12px 12px;border:1px solid #26314f;border-radius:12px;background:#0b1224;color:#e5e7eb;outline:none}
    form input:focus, form select:focus{border-color:#3b82f6;box-shadow:0 0 0 3px rgba(59,130,246,.2)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .help{font-size:12px;color:#93a3b8;margin-top:8px}
    .qr-card{display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:22px}
    .caps{font-size:12px;letter-spacing:.08em;color:#9ca3af;text-transform:uppercase}
    footer{padding:28px 0 40px;color:#9aa5b1}
    .small{font-size:12px}
    .field-error{color:#ef4444;font-size:12px;margin-top:6px}
    input.input-error, select.input-error{border-color:#ef4444 !important; box-shadow:0 0 0 3px rgba(239,68,68,.2) !important}
    .inline-steps{display:flex;gap:12px;flex-wrap:wrap}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;color:#cbd5e1;background:#0b1224;border:1px solid #1f2a44;padding:2px 6px;border-radius:6px}
  </style>
</head>
<body>

  <!-- Demo banner -->
  <div class="banner">DEMO ¬∑ Reconciliation Guardian for PayMe ‚Äî This page demonstrates how the WhatsApp bot prevents shipping unpaid orders.</div>

  <!-- Quick start steps -->
  <div class="strip">
    <div class="container">
      <span class="caps">How to try it:</span>
      <div class="inline-steps">
        <span class="pill">Register</span>
        <span class="pill">Open WhatsApp via <strong>QR / link</strong></span>
        <span class="pill">Message <span class="mono">join south-public</span> (24h)</span>
        <span class="pill">Get <strong>mismatch alerts</strong> (Platform Paid ‚â† PayMe Failed)</span>
      </div>
    </div>
  </div>

  <!-- Hero -->
  <header class="container">
    <div class="hero">
      <div>
        <span class="tag">Real-time reconciliation</span>
        <h1>Never ship an unpaid order again.</h1>
        <p class="lead">The Reconciliation Guardian cross-checks every transaction against <strong>PayMe</strong> and alerts you in WhatsApp before money slips away.</p>
        <div class="cta">
          <a href="#register" class="btn">Register &amp; Connect WhatsApp</a>
          <a href="#how" class="pill">How it works</a>
        </div>
      </div>
      <div class="card">
        <div class="caps">WhatsApp preview</div>
        <div style="height:8px"></div>
        <div class="card" style="background:#0b1224;border-color:#1f2a44">
          <div style="font-weight:700;margin-bottom:4px">‚ö†Ô∏è Alert</div>
          <div class="small" style="color:#cbd5e1">Order #10428 ‚Äî Payment <b>Failed</b> on PayMe, marked <b>Paid</b> on Wix. Do not ship yet.</div>
        </div>
        <div style="height:10px"></div>
        <div class="card" style="background:#0b1224;border-color:#1f2a44">
          <div style="font-weight:700;margin-bottom:4px">‚úÖ Resolved</div>
          <div class="small" style="color:#cbd5e1">Status corrected. You‚Äôre safe to fulfill now.</div>
        </div>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- Pain ‚Üí Solution -->
    <section class="kvs card">
      <div class="problem">
        <h2>When systems disagree, you pay the price.</h2>
        <p>Your store marks an order <b>Paid</b>, but PayMe returns <b>Failed</b>. You ship the product; the payment never arrives.</p>
      </div>
      <div class="solution">
        <h2>The Guardian stops that ‚Äî automatically.</h2>
        <ul class="clean">
          <li>Detects platform vs. PayMe status mismatches in real time</li>
          <li>Sends instant WhatsApp alerts before fulfillment</li>
          <li>Eliminates preventable financial loss</li>
        </ul>
      </div>
    </section>

    <!-- How it works -->
    <section id="how" class="card">
      <h2>Simple setup. Instant protection.</h2>
      <ol style="margin:0 0 0 18px">
        <li><b>Connect your store to PayMe</b> ‚Äî via PayMe API / connector</li>
        <li><b>Guardian monitors transactions</b> 24/7 using PayMe‚Äôs first-party data</li>
        <li><b>Get alerts & a daily summary</b> in WhatsApp (optional email)</li>
      </ol>
      <p class="help">For this demo you don‚Äôt need a full integration ‚Äî just follow the steps in the top strip.</p>
    </section>

    <!-- Benefits -->
    <section class="grid-3">
      <div class="card"><h4>üí∞ Loss Prevention</h4><p class="help">Stop unpaid shipments with automated validation before fulfillment.</p></div>
      <div class="card"><h4>‚ö° Real-time Alerts</h4><p class="help">WhatsApp notifications within seconds of a mismatch.</p></div>
      <div class="card"><h4>üîç Source of Truth</h4><p class="help">PayMe status is definitive ‚Äî no more blame game between systems.</p></div>
    </section>

    <!-- Registration + QR -->
    <section id="register" class="form-wrap">
      <div class="card">
        <h2>Try the Guardian demo now</h2>
        <p class="help">Fill the form so the bot can recognize your company and contact details, then open the bot on WhatsApp to start the 24-hour demo.</p>

        <form id="rg-form" novalidate autocomplete="off">
          <!-- Honeypot to deter bots -->
          <input type="text" name="website" autocomplete="off" style="position:absolute;left:-9999px;top:-9999px" tabindex="-1" aria-hidden="true">

          <label for="company">Company *</label>
          <input id="company" name="company" placeholder="Acme Ltd" required>

          <div class="row">
            <div>
              <label for="name">Name *</label>
              <input id="name" name="name" placeholder="Dana Cohen" required>
            </div>
            <div>
              <label for="email">Business Email *</label>
              <input id="email" name="email" type="email" placeholder="you@company.com" required>
            </div>
          </div>

          <div class="row">
            <div>
              <label for="country">Country *</label>
              <select id="country" name="country" required>
                <option value="IL" selected>üáÆüá± Israel (+972)</option>
                <option value="RU">üá∑üá∫ Russia (+7)</option>
                <option value="US">üá∫üá∏ United States (+1)</option>
                <option value="GB">üá¨üáß United Kingdom (+44)</option>
                <option value="DE">üá©üá™ Germany (+49)</option>
                <option value="FR">üá´üá∑ France (+33)</option>
                <option value="NL">üá≥üá± Netherlands (+31)</option>
                <option value="UA">üá∫üá¶ Ukraine (+380)</option>
              </select>
            </div>
            <div>
              <label for="localPhone">WhatsApp (local format) *</label>
              <!-- User enters NSN without trunk; placeholder updates per country -->
              <input id="localPhone" name="localPhone" inputmode="tel" placeholder="For IL: 5XXXXXXXX" required>
              <div id="err-whatsapp" class="field-error"></div>
            </div>
          </div>

          <!-- Hidden E.164 that is sent to n8n -->
          <input type="hidden" id="whatsapp" name="whatsapp">

          <div style="height:8px"></div>
          <button class="btn" id="submitBtn" type="submit">Register &amp; Connect WhatsApp</button>
          <div id="status" class="help" style="min-height:20px"></div>
          <div class="help">After you register, open the bot: scan the QR or tap the link below. In WhatsApp the message <span class="mono">join south-public</span> is pre-filled.</div>
        </form>
      </div>

      <div class="card qr-card">
        <div class="caps">Open WhatsApp Bot</div>
        <img id="qr" alt="Scan to open WhatsApp bot" width="200" height="200" style="margin:10px 0;border:1px dashed #26314f;border-radius:12px;background:#0b1224" />
        <a id="waLink" class="pill" target="_blank" rel="noopener">Open WhatsApp Bot ‚Üí</a>
        <div class="help">Scan the QR or click the link. Demo mode only ‚Äî no real payments or shipments are triggered.</div>
        <div style="height:8px"></div>
        <div class="small"><b>Quick commands</b>: the chat opens with <span class="mono">join south-public</span>. After activation, you‚Äôll receive alerts when Platform Paid ‚â† PayMe Failed.</div>
      </div>
    </section>

    <!-- Trust & Security -->
    <section class="card">
      <h2>Security first. Always.</h2>
      <ul class="clean">
        <li>Uses <b>PayMe</b> first-party data to validate payment status</li>
        <li>No card data stored; no third-party data sharing</li>
        <li>Works via secure PayMe APIs and webhooks</li>
      </ul>
      <p class="help">Supported today (demo focus): <b>Shopify</b>, <b>Wix</b>. Pilot candidates: <b>WooCommerce</b>, <b>Konimbo</b>.</p>
    </section>
  </main>

  <footer class="container">
    <div style="display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap">
      <div class="small">¬© 2025 Reconciliation Guardian ‚Äî Demo for PayMe</div>
      <div class="small">
        <a href="#" onclick="alert('Add your Privacy Policy URL');return false;">Privacy</a> ¬∑
        <a href="#" onclick="alert('Add your Terms URL');return false;">Terms</a>
      </div>
    </div>
  </footer>

  <script>
    /* ------------------- Configuration ------------------- */
    const REGISTER_URL = "https://dmitreyvladimirovic.app.n8n.cloud/webhook/rg/register";
    const WA_LINK = "https://wa.me/14155238886?text=join%20south-public";

    /* ------------------- Lightweight analytics ------------------- */
    window.dataLayer = window.dataLayer || [];
    function track(event, params = {}) {
      if (window.gtag) gtag('event', event, params);
      window.dataLayer.push({ event, ...params });
      // console.log('[track]', event, params); // keep quiet in production
    }

    /* ------------------- Country rules -------------------
       User enters NSN (national significant number) WITHOUT trunk.
       We still tolerate accidental trunk input (0/8) and strip it.
    */
    const COUNTRIES = {
      IL: { dial:'972', trunk:'0', nsn:[9,9],  localRegex:/^5\d{8}$/,             sample:'5XXXXXXXX',                   hint:'Starts with 5, 9 digits' },
      RU: { dial:'7',   trunk:'8', nsn:[10,10],localRegex:/^9\d{9}$/,            sample:'9XXXXXXXXX',                  hint:'Starts with 9, 10 digits' },
      US: { dial:'1',   trunk:'',  nsn:[10,10],localRegex:/^(?:[2-9]\d{2})(?:[2-9]\d{2})\d{4}$/, sample:'2025550123',   hint:'10 digits; area/office not 0/1' },
      GB: { dial:'44',  trunk:'0', nsn:[10,10],localRegex:/^7\d{9}$/,            sample:'7XXXXXXXXX',                  hint:'Starts with 7, 10 digits' },
      DE: { dial:'49',  trunk:'0', nsn:[10,11],localRegex:/^(?:15|16|17)\d{8,9}$/,sample:'15XXXXXXXXX',                 hint:'Starts with 15/16/17, 10‚Äì11 digits' },
      FR: { dial:'33',  trunk:'0', nsn:[9,9],  localRegex:/^(?:6|7)\d{8}$/,       sample:'6XXXXXXXX or 7XXXXXXXX',      hint:'Starts with 6 or 7, 9 digits' },
      NL: { dial:'31',  trunk:'0', nsn:[9,9],  localRegex:/^6\d{8}$/,             sample:'6XXXXXXXX',                   hint:'Starts with 6, 9 digits' },
      UA: { dial:'380', trunk:'0', nsn:[9,9],  localRegex:/^[3-9]\d{8}$/,         sample:'50XXXXXXX',                   hint:'9 digits; starts 3‚Äì9' }
    };

    /* ------------------- DOM ------------------- */
    const form       = document.getElementById('rg-form');
    const btn        = document.getElementById('submitBtn');
    const statusEl   = document.getElementById('status');
    const waLink     = document.getElementById('waLink');
    const qrImg      = document.getElementById('qr');

    const countrySel = document.getElementById('country');
    const localPhone = document.getElementById('localPhone');
    const hiddenWA   = document.getElementById('whatsapp');
    const waErrEl    = document.getElementById('err-whatsapp');

    /* ------------------- Helpers ------------------- */
    function digitsOnly(s){ return String(s||'').replace(/\D/g,''); }
    function validEmail(v){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(v||'').trim()); }
    function clearPhoneError(){ waErrEl.textContent=''; localPhone.classList.remove('input-error'); }
    function showPhoneError(cc){
      const cfg = COUNTRIES[cc] || {};
      const msg = cfg.hint || (cfg.sample ? `Format: ${cfg.sample}` : 'Invalid number');
      waErrEl.textContent = `Invalid number. ${msg}.`;
      localPhone.classList.add('input-error');
    }

    /* Update placeholder and maxlength when country changes */
    function setLocalConstraints(){
      const cc  = countrySel.value;
      const cfg = COUNTRIES[cc] || {};
      const sampleDigits = digitsOnly(cfg.sample || '');
      const baseLen = sampleDigits.length || (cfg.nsn?.[1] || 15);

      // Placeholder shows the correct local sample for the selected country
      localPhone.placeholder = cfg.sample ? `For ${cc}: ${cfg.sample}` : 'Local number';
      // Allow one extra char for accidental trunk; we will strip it later
      localPhone.maxLength   = baseLen + (cfg.trunk ? 1 : 0);

      clearPhoneError();
    }

    // Some browsers miss "change" occasionally; attach multiple triggers
    countrySel.addEventListener('change', setLocalConstraints);
    countrySel.addEventListener('click',  setLocalConstraints);
    countrySel.addEventListener('focus',  setLocalConstraints);

    /* Force numeric-only input and trim to max length */
    localPhone.addEventListener('input', ()=>{
      const cc  = countrySel.value;
      const cfg = COUNTRIES[cc] || {};
      const sampleDigits = digitsOnly(cfg.sample || '');
      const baseLen = sampleDigits.length || (cfg.nsn?.[1] || 15);
      const max = baseLen + (cfg.trunk ? 1 : 0);

      let d = digitsOnly(localPhone.value);
      if (d.length > max) d = d.slice(0, max);
      localPhone.value = d;
    });

    /* Build and validate E.164 from country + local NSN */
    function buildE164(cc, localRaw){
      const cfg = COUNTRIES[cc]; if(!cfg) return {ok:false, reason:'country'};
      let digits = digitsOnly(localRaw);
      if (!digits) return {ok:false, reason:'empty'};

      // Strip trunk if user typed it (e.g., 0 in IL, 8 in RU)
      if (cfg.trunk && digits.startsWith(cfg.trunk)) digits = digits.slice(cfg.trunk.length);

      // Strict local format per country (if provided)
      if (cfg.localRegex && !cfg.localRegex.test(digits)) return {ok:false, reason:'local-format'};

      // NSN bounds
      const [min,max] = cfg.nsn || [8,15];
      if (digits.length < min || digits.length > max) return {ok:false, reason:'length'};

      // Final E.164
      const e164 = `+${cfg.dial}${digits}`;
      if (!/^\+[1-9]\d{7,14}$/.test(e164)) return {ok:false, reason:'e164'};

      return {ok:true, e164};
    }

    // Validate phone on blur
    localPhone.addEventListener('blur', ()=>{
      const r = buildE164(countrySel.value, localPhone.value);
      if (!r.ok) showPhoneError(countrySel.value); else clearPhoneError();
    });

    /* Initialize QR/link + analytics + initial constraints */
    document.addEventListener('DOMContentLoaded', ()=>{
      waLink.href = WA_LINK;
      qrImg.src   = "https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=" + encodeURIComponent(WA_LINK);
      track('qr_rendered', { page: 'paymetest_final' });
      setLocalConstraints();
      // Ensure placeholder is correct after painting
      setTimeout(setLocalConstraints, 0);
    });

    // Track outbound click
    document.addEventListener('click', (e)=>{
      const a = e.target.closest('a');
      if (a && a.id === 'waLink') track('whatsapp_click', { href: a.href });
    });

    /* Submit to n8n (x-www-form-urlencoded) */
    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      statusEl.textContent=''; clearPhoneError();

      // Honeypot guard
      const hp = form.querySelector('input[name="website"]').value; if (hp) return;

      // Basic required fields
      const company=(document.getElementById('company').value||'').trim();
      const name   =(document.getElementById('name').value||'').trim();
      const email  =(document.getElementById('email').value||'').trim();
      if (!company || !name || !email || !localPhone.value.trim()){
        statusEl.textContent='Please complete all required fields.'; return;
      }
      if (!validEmail(email)){ statusEl.textContent='Please enter a valid email.'; return; }

      // Build validated E.164
      const r = buildE164(countrySel.value, localPhone.value);
      if (!r.ok){ showPhoneError(countrySel.value); statusEl.textContent='Please correct the WhatsApp number.'; return; }
      hiddenWA.value = r.e164;

      const body = new URLSearchParams({
        company, name, email, whatsapp: hiddenWA.value
      }).toString();

      btn.disabled = true; btn.textContent = 'Submitting‚Ä¶';
      try{
        const resp = await fetch(REGISTER_URL, {
          method:'POST',
          headers:{'Content-Type':'application/x-www-form-urlencoded'},
          body
        });
        let j={}; try{ j = await resp.json(); }catch{}
        if (resp.ok){
          statusEl.textContent = 'You‚Äôre registered. Open the WhatsApp bot to start the 24h demo.';
          track('form_submit', { form:'rg_register', status:'ok' });
          btn.textContent = 'Registered ‚úì';
          document.getElementById('waLink').scrollIntoView({behavior:'smooth'});
        } else {
          statusEl.textContent = 'Registration error: ' + (j.error || resp.status);
          track('form_submit', { form:'rg_register', status:'error', code:resp.status });
          btn.disabled=false; btn.textContent='Register & Connect WhatsApp';
        }
      }catch(err){
        statusEl.textContent = 'Network error: ' + err;
        track('form_submit', { form:'rg_register', status:'network_error' });
        btn.disabled=false; btn.textContent='Register & Connect WhatsApp';
      }
    });
  </script>
</body>
</html>
